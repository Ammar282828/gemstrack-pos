import { Product, Settings } from './store';

type EnrichedProduct = Product & {
  totalPrice: number;
};

/**
 * Generates a CSV string from an array of products for WEPrint app.
 * @param products The array of products to include in the CSV.
 * @param settings The current application settings for shop name.
 */
export function generateProductCsv(products: EnrichedProduct[], settings: Settings): void {
  const headers = [
    'sku',
    'product_name',
    'shop_name',
    'weight_display',
    'karat_display',
    'qr_content',
  ];

  const rows = products.map(product => {
    const sku = product.sku;
    const productName = product.name.replace(/,/g, ''); // Remove commas from name
    const shopName = settings.shopName.replace(/,/g, '');
    const weightDisplay = `${product.metalWeightG.toFixed(2)}g`;
    const karatDisplay = (product.metalType === 'gold' && product.karat) ? product.karat.toUpperCase() : '';
    const qrContent = sku; // The QR code will encode the SKU

    return [
      sku,
      productName,
      shopName,
      weightDisplay,
      karatDisplay,
      qrContent
    ].join(',');
  });

  const csvContent = [headers.join(','), ...rows].join('\n');
  
  downloadCsv(csvContent);
}

/**
 * Triggers a browser download of the CSV content.
 * @param csvContent The full CSV string content.
 */
function downloadCsv(csvContent: string): void {
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
  link.setAttribute("download", `weprint_export_${timestamp}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}